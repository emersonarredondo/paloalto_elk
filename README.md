Palo Alto Networks PAN-OS v9.1+ Elastic Stack v7.x Configuration

There are several Palo Alto projects for ELK but most seem to be vacated with no updates in the past year.  Also could not find any with PAN-OS 9.1+ expanded logs (SD-Wan).


## Background
Update existing projects to CIM and PAN 9.1
Initial Updates to early projects:
-Added 10 new fields for traffic logs that started with PAN-OS 9.1
     Rule UUID, HTTP/2 Connection, Link Change Count, Policy ID, Link Switches, SD-WAN Cluster, SD-WAN Device Type, SD-WAN Cluster Type, SD-WAN Site, Dynamic User Group Name
     Most will be blank or zero except for Rule UUID unless you use advanced features of the PA
-Changed attribute names from the default PA field names to Common Information Model (CIM) where applicable.  
     Allow you to import CIM Traffic and Threat visualizations
-Added DNS filter to provide hostnames not just the IP

Dashboard and Visualizations are included  


****************************************************************************************************************************************  
Credit and Contributions
 I have found several older OpenSource GitHub projects on Palo Alto to Elk setups and whish to thank the following early developers.  
 shadow-box - (https://github.com/shadow-box/Palo-Alto-Networks-ELK-Stack)
 sm-biz - (https://github.com/sm-biz/paloalto-elasticstack-viz)
**************************************************************************************************************************************** 

## Tutorial

This project was built on Ubuntu 20.04, and adding the ELK repositories so that the ELK stack stays current.  Instructions are provided for this OS base + ELK setup.

## Existing ELK Install

Once you have ELK up and running start here

- Download the files from this repo
  - pan-os.conf
  - traffic_template_mapping.json
  - threat_template_mapping.json
  - searches-base.json
  - visualisations-base.json
  - dashboards-base.json

- Edit 'pan-os.conf'
  - **Set your timezone correctly** *(Very important)*
 - **RAW Log**
	The RAW output from the Palo Alto is saved in each document in the message field.  This is required
	if you are on a PCI or other regulated firewall.  If not and you want to save space, uncomment this section
to not store the non-parsed raw syslog (Optional):
  #      mutate {
  #          # Original message has been fully parsed, so remove it.
  #          remove_field => [ "message" ]
  #      }
    
- **dnsmasq**
	If you installed dnsmasq on you logstash server, then uncomment the two lines that look like this 
      	to send dns lookups to the local dnsmasq service
#                nameserver => [ "127.0.0.1" ] 

  - **Copy files to your server**
Copy pan-os.conf to your **conf** directory. For Ubuntu/Debian this is "/etc/logstash/conf.d/
- Upload the two pre-built index templates with additional GeoIP fields
```
curl -XPUT http://<your-elasticsearch-server>:9200/_template/panos-traffic?pretty -H 'Content-Type: application/json' -d @traffic_template_mapping.json
curl -XPUT http://<your-elasticsearch-server>:9200/_template/panos-threat?pretty -H 'Content-Type: application/json' -d @threat_template_mapping.json
```    
- Restart Elastic Search & LogStash
sudo systemctl restart elasticsearch.service
sudo systemctl restart logstash.service


- Configure your PANW Firewall(s) to send syslog messages to your Elastic Stack server
***MORE DETAILS COMMIN SOON***
  
- Ensure that your firewall generates at least one traffic, threat, system & config syslog entry each
 - Traffic will be generated by just going to a web site (make sure you setup logging for your policies). 
 - You may have to trigger a threat log entry. Follow [this guide](https://live.paloaltonetworks.com/t5/Management-Articles/How-to-Test-Threat-Prevention-Using-a-Web-Browser/ta-p/62073) from Palo Alto for instructions
  - After committing to set your syslog server, you will need to do another commit (any change) to actually send a config log message.  Try changing the order of a rule and committing it.
  
- Once the data is rolling, login to Kibana and create the 4 new index patterns, all with a Time Filter field of '@timestamp'
	Stack Management -> Index Patterns
		+Create Index
		Type the name of each log type then hit next
		Select Timestamp and save
These are the 4 indexes you need to create
  - panos-traffic
  - panos-threat
  - panos-system
  - panos-config

- And lastly, import the saved object files (in this orders)
  - searches-base.json
  - visualisations-base.json
  - dashboards-base.json
  
  
 
## References
